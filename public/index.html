<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="css/index.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="dashboard-title">
      <h1>Bank Dashboard</h1>
    </div>
    <div class="left-nav">
      <img src="./src/assets/icons8-user-50.png" alt="">
    </div>
  </nav>

  <!-- Side Bar -->
  <div class="sidebar">
    <div class="menu">
      <div class="item"><a href="#">My Accounts</a></div>
      <div class="item"><a href="#">Bill Payments</a></div>
      <div class="item"><a href="#">Transfer Funds</a></div>
      <div class="item">
        <a href="" id="ecoCreditBtn" class="sub-btn">EcoCredit</a>
        <div id="ecoCreditSubMenu" class="sub-menu" style="display: none;">
          <a href="./dashboard.html" class="sub-item">Dashboard</a>
          <a href="./achievement.html" class="sub-item">Achievement</a>
          <a href="./trends.html" class="sub-item">Trends</a>
          <a href="./leaderboard.html" class="sub-item">Leaderboard</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Add New Data Button -->
    <button id="addDataBtn" class="add-data-button">+</button>
    
    <!-- Table with integrated data entry form as the first row -->
    <table>
      <thead>
        <!-- The header will be populated by JavaScript -->
      </thead>
      <tbody>
        <!-- Data Entry Row (initially hidden) -->
        <tr id="dataEntryRow" style="display: table-row;">
          <td><input type="text" id="dateInput" placeholder="YYYY-MM-DD" required></td>
          <td><input type="text" id="itemInput" placeholder="Item" required></td>
          <td><input type="text" id="locationInput" placeholder="Location" required></td>
          <td><input type="text" id="amountInput" placeholder="Amount" required></td>
          <td><button id="submitDataBtn">Add</button></td>
        </tr>
        <!-- Existing table data rows will be dynamically inserted here -->
      </tbody>
    </table>
  </div>

  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        fetch("/data/sample-spending.csv")
            .then(res => res.text())
            .then(data => {
                Papa.parse(data, {
                    header: true,
                    complete: function(results) {
                        let rows = results.data;

                        rows.sort((a, b) => {
                        let dateA = new Date(a.Date), dateB = new Date(b.Date);
                        return dateB - dateA; // For descending order
                    });

                        let table = document.querySelector("table");
                        let visibleColumns = ['Date', 'item', 'location', 'Amount'];
    
                        // Create the table header row
                        let headerRow = document.createElement("tr");
                        Object.keys(rows[0]).forEach(header => {
                            let th = document.createElement("th");
                            th.textContent = header;
                            if (!visibleColumns.includes(header)) {
                                th.classList.add("hide-column");
                            }
                            headerRow.appendChild(th);
                        });
                        table.querySelector('thead').appendChild(headerRow);
    
                        // Generate data rows
                        rows.forEach(row => {
                            let tr = document.createElement("tr");
                            Object.entries(row).forEach(([header, cell]) => {
                                let td = document.createElement("td");
                                td.textContent = cell;
                                if (!visibleColumns.includes(header)) {
                                    td.classList.add("hide-column");
                                }
                                tr.appendChild(td);
                            });
                            table.querySelector('tbody').appendChild(tr);
                        });
                    }
                });
            });

        // Event listener for the EcoCredit button
        document.getElementById('ecoCreditBtn').addEventListener('click', function(event) {
            event.preventDefault();
            var submenu = document.getElementById('ecoCreditSubMenu');
            submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';
        });

        // Event listener for Add Data button
        document.getElementById('addDataBtn').addEventListener('click', function(event) {
        event.preventDefault();
        var dataEntryRow = document.getElementById('dataEntryRow');
        dataEntryRow.style.display = dataEntryRow.style.display === 'none' ? 'table-row' : 'none';
    });

        // Event listener for the submit action on the Add button
    document.getElementById('submitDataBtn').addEventListener('click', async function(event) {
        event.preventDefault(); // This prevents the default form submission behavior


          // Get form data
          let data = {
            date: document.getElementById('dateInput').value,
            item: document.getElementById('itemInput').value,
            location: document.getElementById('locationInput').value,
            amount: parseFloat(document.getElementById('amountInput').value).toFixed(2)
        };

        console.log("Data to be sent:", data); // Log the data

  // Send data to the server
  const response = await fetch('/addData', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
  });

  // Handle the response from the server
  response.json().then(responseData => {
    if (responseData.message === 'Data added successfully') {
      // Update the table here
      addDataToTable(data);

      // Reset and hide the data entry form
      document.getElementById('dateInput').value = '';
      document.getElementById('itemInput').value = '';
      document.getElementById('locationInput').value = '';
      document.getElementById('amountInput').value = '';
      document.getElementById('dataEntryRow').style.display = 'none';
    } else {
      // Handle error
      console.error('Error adding data:', responseData.message);
    }
  });
});


    // Function to add data to the table
    function addDataToTable(data) {
    let table = document.querySelector("table tbody");
    let tr = document.createElement("tr");

    // Add cells for visible columns
    let dateTd = document.createElement("td");
    dateTd.textContent = data.date;
    tr.appendChild(dateTd);

    let itemTd = document.createElement("td");
    itemTd.textContent = data.item;
    tr.appendChild(itemTd);

    let locationTd = document.createElement("td");
    locationTd.textContent = data.location;
    tr.appendChild(locationTd);

    let amountTd = document.createElement("td");
    amountTd.textContent = data.amount;
    tr.appendChild(amountTd);

    // Add hidden cells for EcoCredit and Details
    let ecoCreditTd = document.createElement("td");
    ecoCreditTd.classList.add("hide-column");
    tr.appendChild(ecoCreditTd);

    let detailsTd = document.createElement("td");
    detailsTd.classList.add("hide-column");
    tr.appendChild(detailsTd);

    table.insertBefore(tr, table.firstChild); // Insert at the beginning of the table
}



        // Function to refresh the table display with new CSV data
        function refreshTableDisplay(rows) {
            let table = document.querySelector("table tbody");

            // Clear existing table rows except for the header
            while (table.firstChild) {
                table.removeChild(table.firstChild);
            }

            // Insert the data entry row at the beginning
            let dataEntryRow = document.getElementById('dataEntryRow');
            table.appendChild(dataEntryRow.cloneNode(true)); // Clone and insert data entry row

            // Add new data rows to the table
            rows.forEach(row => {
                let tr = document.createElement("tr");
                Object.values(row).forEach(cell => {
                    let td = document.createElement("td");
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                table.appendChild(tr);
            });
        }

    });
</script>
</body>
</html>